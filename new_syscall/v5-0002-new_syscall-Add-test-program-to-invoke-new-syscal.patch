From 072e862a2b16870683bac8c3c327a252e04d2c03 Mon Sep 17 00:00:00 2001
From: Peter Meas <peter_meas@fall2025-uml.kdlp.underground.software>
Date: Tue, 23 Sep 2025 04:49:25 +0000
Subject: [PATCH v5 2/4] new_syscall: Add test program to invoke new syscall
 and updated init

Signed-off-by: Peter Meas <peter_meas@fall2025-uml.kdlp.underground.software>
---
 peter_meas/new_syscall/Makefile           | 10 +++++
 peter_meas/new_syscall/libc.config        | 16 ++++++++
 peter_meas/new_syscall/libc_test.c        |  9 +++++
 peter_meas/new_syscall/patched_output.txt | 47 +++++++++++++++++++++++
 peter_meas/new_syscall/test.c             | 21 ++++++++++
 5 files changed, 103 insertions(+)
 create mode 100644 peter_meas/new_syscall/Makefile
 create mode 100644 peter_meas/new_syscall/libc.config
 create mode 100644 peter_meas/new_syscall/libc_test.c
 create mode 100644 peter_meas/new_syscall/patched_output.txt
 create mode 100644 peter_meas/new_syscall/test.c

diff --git a/peter_meas/new_syscall/Makefile b/peter_meas/new_syscall/Makefile
new file mode 100644
index 0000000..e81b915
--- /dev/null
+++ b/peter_meas/new_syscall/Makefile
@@ -0,0 +1,10 @@
+CC := riscv64-linux-gnu-gcc
+CFLAGS := -gdwarf-5 -static-pie -fPIC --sysroot=../sysroot
+
+all: init
+
+init: test.c
+	$(CC) $(CFLAGS) $< -o $@
+
+clean:
+	rm -f init
diff --git a/peter_meas/new_syscall/libc.config b/peter_meas/new_syscall/libc.config
new file mode 100644
index 0000000..fbb35fc
--- /dev/null
+++ b/peter_meas/new_syscall/libc.config
@@ -0,0 +1,16 @@
+# kernel headers installed in sysroot
+KERNEL_HEADERS="../sysroot/usr/include"
+
+# enable debugging info
+UCLIBC_EXTRA_CFLAGS="-gdwarf-5"
+
+# this will be the main libc so it can go directly in /usr
+RUNTIME_PREFIX="/"
+DEVEL_PREFIX="/usr"
+
+# include linux specific syscalls
+UCLIBC_LINUX_SPECIFIC=y
+
+# include posix realtime functions
+UCLIBC_HAS_REALTIME=y
+UCLIBC_HAS_ADVANCED_REALTIME=y
diff --git a/peter_meas/new_syscall/libc_test.c b/peter_meas/new_syscall/libc_test.c
new file mode 100644
index 0000000..620f6d2
--- /dev/null
+++ b/peter_meas/new_syscall/libc_test.c
@@ -0,0 +1,9 @@
+#include <stdio.h>
+#include <sys/reboot.h>
+#include <linux/reboot.h>
+
+int main(void)
+{
+	puts("Hello from C!");
+	reboot(LINUX_REBOOT_CMD_POWER_OFF);
+}
diff --git a/peter_meas/new_syscall/patched_output.txt b/peter_meas/new_syscall/patched_output.txt
new file mode 100644
index 0000000..119b068
--- /dev/null
+++ b/peter_meas/new_syscall/patched_output.txt
@@ -0,0 +1,47 @@
+Linux version 6.16.0-kdlp-dirty (peter_meas@kdlp) (riscv64-linux-gnu-gcc (GCC) 15.2.1 20250808 (Red Hat Cross 15.2.1-1), GNU ld version 2.44-1.fc42) #2 Tue Sep 23 03:47:59 UTC 2025
+random: crng init done
+Machine model: riscv-virtio,qemu
+OF: reserved mem: Reserved memory: No reserved-memory node in the DT
+Zone ranges:
+  DMA32    [mem 0x0000000080000000-0x0000000087ffffff]
+  Normal   empty
+Movable zone start for each node
+Early memory node ranges
+  node   0: [mem 0x0000000080000000-0x0000000087ffffff]
+Initmem setup node 0 [mem 0x0000000080000000-0x0000000087ffffff]
+riscv: base ISA extensions achim
+riscv: ELF capabilities acim
+Ticket spinlock: enabled
+Kernel command line: panic=-1
+printk: log buffer data + meta data: 131072 + 458752 = 589824 bytes
+Dentry cache hash table entries: 16384 (order: 5, 131072 bytes, linear)
+Inode-cache hash table entries: 8192 (order: 4, 65536 bytes, linear)
+Built 1 zonelists, mobility grouping on.  Total pages: 32768
+mem auto-init: stack:all(zero), heap alloc:off, heap free:off
+SLUB: HWalign=64, Order=0-3, MinObjects=0, CPUs=1, Nodes=1
+NR_IRQS: 64, nr_irqs: 64, preallocated irqs: 0
+riscv-intc: 64 local interrupts mapped
+clint: clint@2000000: timer running at 10000000 Hz
+clocksource: clint_clocksource: mask: 0xffffffffffffffff max_cycles: 0x24e6a1710, max_idle_ns: 440795202120 ns
+sched_clock: 64 bits at 10MHz, resolution 100ns, wraps every 4398046511100ns
+Calibrating delay loop (skipped), value calculated using timer frequency.. 20.00 BogoMIPS (lpj=40000)
+pid_max: default: 32768 minimum: 301
+Mount-cache hash table entries: 512 (order: 0, 4096 bytes, linear)
+Mountpoint-cache hash table entries: 512 (order: 0, 4096 bytes, linear)
+Memory: 125312K/131072K available (1435K kernel code, 873K rwdata, 160K rodata, 343K init, 166K bss, 5400K reserved, 0K cma-reserved)
+clocksource: jiffies: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 7645041785100000 ns
+cpu0: Ratio of byte access time to unaligned word access is 7.00, unaligned accesses are fast
+clocksource: Switched to clocksource clint_clocksource
+Unpacking initramfs...
+Freeing initrd memory: 112K
+workingset: timestamp_bits=62 max_order=15 bucket_order=0
+riscv-plic: plic@c000000: mapped 95 interrupts with 1 handlers for 2 contexts.
+Serial: 8250/16550 driver, 4 ports, IRQ sharing disabled
+printk: legacy console [ttyS0] disabled
+10000000.serial: ttyS0 at MMIO 0x10000000 (irq = 3, base_baud = 230400) is a 16550A
+printk: legacy console [ttyS0] enabled
+clk: Disabling unused clocks
+Freeing unused kernel image (initmem) memory: 340K
+This architecture does not have kernel memory protection.
+Run /init as init process
+Peter Meas is running initKernel panic - not syncing: Attempted to kill init! exitcode=0x00000000
diff --git a/peter_meas/new_syscall/test.c b/peter_meas/new_syscall/test.c
new file mode 100644
index 0000000..ee36115
--- /dev/null
+++ b/peter_meas/new_syscall/test.c
@@ -0,0 +1,21 @@
+#include <unistd.h>
+#include <sys/syscall.h>
+#include <errno.h>
+#include <string.h>
+#include <stdio.h>
+
+int main(int argc, char** argv) {
+
+	char buff[128];
+	long numBytes;
+
+	numBytes = syscall(__NR_kdlp, buff, sizeof(buff));
+	if (numBytes < 0) {
+
+		printf("Syscall failed: %s\n", strerror(-numBytes));
+		return -numBytes;
+	} else {
+		write(1, buff, numBytes);
+	}
+	return 0;
+}
--
2.51.0

